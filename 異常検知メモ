# 異常検知とは
ダイレクトのライブラリ品質において異常検出を行う。

特徴量は考察中だが
- 複雑度（いろいろある）
- コミット回数
- JOBエラー発生数
- JOB実行数

このあたりではないかと見ている（データ集まり始めてからでないとわからん）


## スパイク
性能評価におけるスパイク値は無視する話はままある。事実とは思う。
然しながらライブラリメトリックの急変は性能評価のスパイクとは大きく異なる。
- 性能評価のスパイク→すぐ戻る、何事もなかったかのように
- ライブラリメトリックのスパイク→戻らない、戻れない

## 外れ値と変化点の識別
この辺もできてないくて同じような扱いになっているい可能性あり。


そう、あたかも在宅勤務太りで増えてしまった体重のように。
なにも対処しなければ戻れないし、そのままの状態を継続すればさらに悪化する性質が予見される。

## 納品時の絶対値ではなく開発プロセスにおける時系列で評価する
- これまでも納品と併せてライブラリ品質のレポートがあったかもしれない。ただし納品時の値を単に見ただけでは何も問題は明らかにならない、いいのかわるいのか、何も判断はできない。

- 取得した結果を全量人の目でチェックするのもの継続的に行うのは難しい。
異常検出を自動で行いその対象だけを人の目で確認するプロセスにより運営を行う。っー8


## 何を守りたいか

`早く気付いて早く対処する`
この一言に集約される。



---
- 人では気づけない（大量、日立プロパーで全量レビューしないプロジェクト方針）

日立プロパーが全量レビューはしないと言っている。プロジェクト事情もあり選択の1つではある。だが問題の検出は遅れる可能性はある（担当者任せの実装、ガバナンス薄れる）。人レビューによる検出が困難であるならばCIの特性を活かして日々検出を試みる。

---
- 早期の検出により「今からでは改修できません」妥協を回避

納品後に問題検出→影響大きすぎて改修できません（よくある話）。この手の「もうどうにもらないので許容」という判断にならない為にも早期検出が重要。一度増えた複雑度などのめトリック値は自然体で元に戻るはずもない。

---
- マージでの大きなコンフリクトを早期に回避

同一時期に同一モジュールを別プロジェクトで改修している状況においてメトリック値が異なる方向に改修が行われる場合にいざマージを行った場合に大きなコンフリクトが検出されるリスクを抱える可能性がある。

---


## 何をトリガーに悪化するのか、分析する

### 変化点を捕らえたい
`変化点検出`


時系列データのパターンが急激に変化する箇所を検知するための手法。

- ホテリング理論
  - 予測モデルが必要 → ARモデルなど
  - 予測値と実測値の刷れを異常度として定義して変換点を検出する
    - 異常度 = （予測値 - 実測値） ^ 2 
      - 減った場合も捕らえる必要がある→モジュール分割したなど（マージ時に問題となる可能性）

https://www.kabuku.co.jp/developers/anomaly-detect

---

ARモデルを用いた変化点検知の手順
1. 時系列データを訓練データと検証データに分ける
1. 訓練データからARモデルを推定する
1. 2で求めたARモデルを使用して検証データを予測する
1. (予測値-実測値)²を各時点の異常度とする
1. 異常度がある閾値以上であれば、その時点を変化点とする


（参考）https://www.albert2005.co.jp/knowledge/machine_learning/anomaly_detection_basics/anomaly_detection_time

---

`SR法による検出` → Spectral Residual
- https://laboro.ai/activity/column/engineer/eg-time-series-anomaly-detection/
- https://10001ideas.com/2019/09/21/microsoft%E3%81%A7%E3%81%AE%E6%99%82%E7%B3%BB%E5%88%97%E3%83%87%E3%83%BC%E3%82%BF%E7%95%B0%E5%B8%B8%E6%A4%9C%E7%9F%A5%E6%89%8B%E6%B3%95%E3%81%AE%E8%AB%96%E6%96%87%EF%BC%9A%E3%80%8Ctime-series-anomaly/
- https://engineering.linecorp.com/ja/blog/kdd-2019-report/

初期はデータが無いのでSR法でラベリングを行いその後SRーCNNに移行していくのがよいのでは、という提案

- https://qiita.com/DS27/items/af375c1b8fdf2610b8a4
ChangeFinder：自己回帰モデル（ARモデル）の学習に「オンライン学習」と「忘却機能」を追加したSDARアルゴリズムを活用した手法が「ChangeFinder」です

- https://www.youtube.com/watch?v=es_3W6H4oSI
- https://blog.matsumoto-r.jp/files/bache2006middleslide.pdf
- https://bigdata-tools.com/%E6%99%82%E7%B3%BB%E5%88%97%E8%A7%A3%E6%9E%90%E3%81%AB%E3%82%88%E3%82%8B95%E4%BF%A1%E9%A0%BC%E5%8C%BA%E9%96%93%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E7%95%B0%E5%B8%B8%E6%A4%9C%E7%9F%A5/
- https://www.kabuku.co.jp/developers/time_series_anomaly_detect

---

### ChangeFinder

もろもろ調査中。興味深い。
http://192.168.10.104:3001/b/s6FbRxQ7YvanfH2wt/board/WnWz4veNAoj2GKzBJ

パラメータチューニングが繊細な模様。
総当たりか。。。→機械学習で使った手法などを用いる展開だろう。















